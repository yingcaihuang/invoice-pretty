name: Deployment Notification

on:
  deployment_status:

concurrency:
  group: notify-${{ github.event.deployment.id }}-${{ github.event.deployment_status.state }}
  cancel-in-progress: true

jobs:
  notify-deployment:
    # 只处理 in_progress (Approved) 和 failure (Rejected/Failed)
    # 并且只针对 pro 环境发送 Approved 通知 (dev 环境自动批准无需通知)
    if: |
      (github.event.deployment_status.state == 'in_progress' && github.event.deployment.environment == 'pro') || 
      github.event.deployment_status.state == 'failure'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set Environment Variables
        id: vars
        run: |
          state="${{ github.event.deployment_status.state }}"
          env_name="${{ github.event.deployment.environment }}"
          
          echo "Detected state: $state"
          echo "Environment: $env_name"
          
          if [ "$state" == "in_progress" ]; then
            echo "WORKFLOW_STATUS=Deployment Approved" >> $GITHUB_ENV
            echo "COMMIT_MESSAGE=Deployment approved for environment: $env_name" >> $GITHUB_ENV
          elif [ "$state" == "failure" ]; then
             echo "WORKFLOW_STATUS=Deployment Rejected" >> $GITHUB_ENV
             echo "COMMIT_MESSAGE=Deployment rejected or failed for environment: $env_name" >> $GITHUB_ENV
          fi
          
          # 设置 Teams URL
          if [ "$env_name" == "pro" ]; then
             echo "TEAMS_URL=${{ secrets.PRO_TEAMS_URL }}" >> $GITHUB_ENV
          elif [ "$env_name" == "dev" ]; then
             echo "TEAMS_URL=${{ secrets.DEV_TEAMS_URL }}" >> $GITHUB_ENV
          else
             # Fallback or other environments
             echo "TEAMS_URL=${{ secrets.DEV_TEAMS_URL }}" >> $GITHUB_ENV
          fi

      - name: Send Notification
        if: env.TEAMS_URL != ''
        env:
          # TEAMS_URL is set in previous step
          # WORKFLOW_STATUS is set in previous step
          RELEASE_VERSION: ${{ github.event.deployment.ref }}
          # COMMIT_MESSAGE is set in previous step
          # Override GITHUB_RUN_ID to point to the original workflow run if possible
          # deployment_status payload has target_url which is the workflow run url
          # But teams-push.py constructs URL from GITHUB_RUN_ID. 
          # We can't easily change GITHUB_RUN_ID to match the original run ID without parsing target_url.
          # For now, let it point to this notification run, or we can try to parse.
        run: python teams-push.py
