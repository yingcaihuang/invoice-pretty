name: Build and Release

on:
  push:
    tags:
      - 'v*'  # ÂΩìÊé®ÈÄÅÁâàÊú¨Ê†áÁ≠æÊó∂Ëß¶Âèë
  workflow_dispatch:  # ÂÖÅËÆ∏ÊâãÂä®Ëß¶Âèë
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

env:
  PYTHON_VERSION: '3.11'

jobs:
  # WindowsÊûÑÂª∫‰Ωú‰∏ö
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build Windows EXE
      run: |
        python build_windows.py --exe-only
    
    - name: Create portable package
      run: |
        python build_windows.py --portable-only
    
    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: |
          dist/invoice_pretty.exe
          dist/invoice_pretty_portable.zip
        retention-days: 30

  # macOS Intel (x86_64) ÊûÑÂª∫‰Ωú‰∏ö
  build-macos-intel:
    runs-on: macos-15-intel  # Intel-based runner (updated from deprecated macos-13)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/Library/Caches/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install system dependencies
      run: |
        brew install create-dmg
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build macOS app and DMG (Intel) - Import Fixed Version
      run: |
        python build_import_fixed.py
    
    - name: Rename artifacts for Intel
      run: |
        cd dist
        if [ -f "invoice_pretty.dmg" ]; then
          mv "invoice_pretty.dmg" "invoice_pretty_intel.dmg"
        fi
        if [ -d "invoice_pretty.app" ]; then
          mv "invoice_pretty.app" "invoice_pretty_intel.app"
        fi
    
    - name: Upload macOS Intel artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-intel-build
        path: |
          dist/invoice_pretty_intel.dmg
          dist/invoice_pretty_intel.app
        retention-days: 30

  # macOS Apple Silicon (ARM64) ÊûÑÂª∫‰Ωú‰∏ö
  build-macos-arm:
    runs-on: macos-latest  # ARM-based runner (M1/M2)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/Library/Caches/pip
        key: ${{ runner.os }}-arm64-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-arm64-pip-
    
    - name: Install system dependencies
      run: |
        brew install create-dmg
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build macOS app and DMG (ARM64) - Import Fixed Version
      run: |
        python build_import_fixed.py
    
    - name: Rename artifacts for ARM64
      run: |
        cd dist
        if [ -f "invoice_pretty.dmg" ]; then
          mv "invoice_pretty.dmg" "invoice_pretty_arm64.dmg"
        fi
        if [ -d "invoice_pretty.app" ]; then
          mv "invoice_pretty.app" "invoice_pretty_arm64.app"
        fi
    
    - name: Upload macOS ARM64 artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-arm64-build
        path: |
          dist/invoice_pretty_arm64.dmg
          dist/invoice_pretty_arm64.app
        retention-days: 30

  # ÂàõÂª∫GitHub Release
  create-release:
    needs: [build-windows, build-macos-intel, build-macos-arm]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
    
    - name: List downloaded files
      run: |
        echo "Downloaded artifacts:"
        find . -type f -name "*.exe" -o -name "*.dmg" -o -name "*.zip" -o -name "*.app" | sort
    
    - name: Create release notes
      id: release_notes
      run: |
        cat > release_notes.md << 'EOF'
        # PDFÂèëÁ•®ÊãºÁâàÊâìÂç∞Á≥ªÁªü ${{ steps.get_version.outputs.version }}
        
        ##  Êñ∞ÁâàÊú¨ÂèëÂ∏É
        
        Êô∫ËÉΩÂ§ÑÁêÜ12306ÁîµÂ≠êÂèëÁ•®ÔºåÊîØÊåÅPDFÂíåZIPÊñá‰ª∂Ôºå‰∏ÄÈîÆÁîüÊàêÊãºÁâàÊâìÂç∞Êñá‰ª∂„ÄÇ
        
        ## [INFO] ÁïåÈù¢È¢ÑËßà
        
        ### ‰∏ªÁïåÈù¢
        ![Á≥ªÁªü‰∏ªÁïåÈù¢](https://raw.githubusercontent.com/yingcaihuang/invoice-pretty/main/img/assets/img1.png)
        
        ### Â§ÑÁêÜÁïåÈù¢
        ![Â§ÑÁêÜÁïåÈù¢](https://raw.githubusercontent.com/yingcaihuang/invoice-pretty/main/img/assets/img2.png)
        
        ## [INFO] ‰∏ãËΩΩËØ¥Êòé
        
        ### WindowsÁî®Êà∑
        - **invoice_pretty.exe** - ÂçïÊñá‰ª∂ÂèØÊâßË°åÁ®ãÂ∫èÔºåÂèåÂáªÂç≥ÂèØËøêË°å
        - **invoice_pretty_portable.zip** - ÁªøËâ≤‰æøÊê∫ÁâàÔºåËß£ÂéãÂç≥Áî®
        
        ### macOSÁî®Êà∑
        - **invoice_pretty_intel.dmg** - Intel Mac (x86_64) ÂÆâË£ÖÂåÖ
        - **invoice_pretty_arm64.dmg** - Apple Silicon Mac (M1/M2) ÂÆâË£ÖÂåÖ
        
        ## ‚ú® ‰∏ªË¶ÅÂäüËÉΩ
        
        - üîÑ ÊîØÊåÅPDFÊñá‰ª∂ÂíåZIPÂéãÁº©ÂåÖÊâπÈáèÂ§ÑÁêÜ
        - üìÑ 2Âàó4Ë°åA4Á∫∏Âº†ÊãºÁâàÂ∏ÉÂ±ÄÔºåËäÇÁúÅ50%Á∫∏Âº†
        - üé® Áé∞‰ª£ÂåñÂõæÂΩ¢Áî®Êà∑ÁïåÈù¢
        - ‚ö° ÂÆûÊó∂Â§ÑÁêÜËøõÂ∫¶ÊòæÁ§∫
        - üìä ËØ¶ÁªÜÁöÑÂ§ÑÁêÜÊó•Âøó‰ø°ÊÅØ
        - [INFO] Êô∫ËÉΩÊñá‰ª∂È™åËØÅÂíåÈîôËØØÂ§ÑÁêÜ
        
        ## üñ•Ô∏è Á≥ªÁªüË¶ÅÊ±Ç
        
        ### Windows
        - Windows 7/8/10/11 (64‰ΩçÊé®Ëçê)
        - Êó†ÈúÄÈ¢ùÂ§ñ‰æùËµñÔºåÂºÄÁÆ±Âç≥Áî®
        
        ### macOS
        - macOS 10.14+ (MojaveÊàñÊõ¥È´òÁâàÊú¨)
        - Intel MacÊàñApple Silicon Mac
        
        ##  ‰ΩøÁî®ÊñπÊ≥ï
        
        1. ‰∏ãËΩΩÂØπÂ∫îÁ≥ªÁªüÁöÑÂÆâË£ÖÂåÖ
        2. Windows: ÂèåÂáªEXEÊñá‰ª∂ÊàñËß£Âéã‰æøÊê∫Áâà
        3. macOS: ÊâìÂºÄDMGÊñá‰ª∂ÔºåÊãñÊãΩÂà∞ApplicationsÊñá‰ª∂Â§π
        4. ÂêØÂä®Á®ãÂ∫èÔºåÈÄâÊã©PDFÊñá‰ª∂ÊàñZIPÂéãÁº©ÂåÖ
        5. ÈÄâÊã©ËæìÂá∫ÁõÆÂΩïÔºåÁÇπÂáª"ÂºÄÂßãÊãºÁâàÂ§ÑÁêÜ"
        
        ## [INFO] ÊäÄÊúØÁâπÊÄß
        
        - Âü∫‰∫éPyMuPDFÁöÑÈ´òÊÄßËÉΩPDFÂ§ÑÁêÜ
        - ÊîØÊåÅÂ§öÁßçÂõæÂÉèÊ†ºÂºèÂíåÂéãÁº©ÁÆóÊ≥ï
        - Êô∫ËÉΩÂ∏ÉÂ±ÄÁÆóÊ≥ïÔºå‰øùÊåÅÂèëÁ•®Á∫µÊ®™ÊØî
        - 300DPIÈ´òË¥®ÈáèËæìÂá∫
        - Ë∑®Âπ≥Âè∞ÂÖºÂÆπÊÄß
        
        ## [INFO] ÂäüËÉΩÂ±ïÁ§∫
        
        | ÂäüËÉΩÁâπÁÇπ | ÁïåÈù¢Â±ïÁ§∫ |
        |----------|----------|
        | **Áé∞‰ª£ÂåñÁïåÈù¢** | ÁÆÄÊ¥ÅÁæéËßÇÁöÑÁî®Êà∑ÁïåÈù¢ÔºåÊîØÊåÅÊãñÊãΩÊìç‰Ωú |
        | **ÊâπÈáèÂ§ÑÁêÜ** | ‰∏ÄÊ¨°ÊÄßÂ§ÑÁêÜÂ§ö‰∏™PDFÊñá‰ª∂ÂíåZIPÂéãÁº©ÂåÖ |
        | **ÂÆûÊó∂ËøõÂ∫¶** | ÊòæÁ§∫Â§ÑÁêÜËøõÂ∫¶ÂíåËØ¶ÁªÜÊó•Âøó‰ø°ÊÅØ |
        | **Êô∫ËÉΩÂ∏ÉÂ±Ä** | 2Âàó4Ë°åÊãºÁâàÔºåËäÇÁúÅ50%Á∫∏Âº† |
        
        ### ‰∏ªË¶ÅÁïåÈù¢ÂäüËÉΩ
        - üéØ **Êñá‰ª∂ÈÄâÊã©**: ÊîØÊåÅÊãñÊãΩÊ∑ªÂä†PDFÊñá‰ª∂ÂíåZIPÂéãÁº©ÂåÖ
        - üìÅ **ÊâπÈáèÂ§ÑÁêÜ**: ‰∏ÄÊ¨°ÊÄßÂ§ÑÁêÜÂ§ö‰∏™ÂèëÁ•®Êñá‰ª∂  
        - ‚ö° **ÂÆûÊó∂ËøõÂ∫¶**: ÊòæÁ§∫Â§ÑÁêÜËøõÂ∫¶ÂíåËØ¶ÁªÜÊó•Âøó
        - üé® **Áé∞‰ª£ËÆæËÆ°**: ÁÆÄÊ¥ÅÁæéËßÇÁöÑÁî®Êà∑ÁïåÈù¢
        
        ---
        
        Â¶ÇÊúâÈóÆÈ¢òÊàñÂª∫ËÆÆÔºåËØ∑Âú®GitHub Issues‰∏≠ÂèçÈ¶à„ÄÇ
        EOF
        
        echo "release_notes<<EOF" >> $GITHUB_OUTPUT
        cat release_notes.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        name: PDFÂèëÁ•®ÊãºÁâàÊâìÂç∞Á≥ªÁªü ${{ steps.get_version.outputs.version }}
        body: ${{ steps.release_notes.outputs.release_notes }}
        draft: false
        prerelease: false
        files: |
          ./windows-build/invoice_pretty.exe
          ./windows-build/invoice_pretty_portable.zip
          ./macos-intel-build/invoice_pretty_intel.dmg
          ./macos-arm64-build/invoice_pretty_arm64.dmg
        fail_on_unmatched_files: false

    - name: Send Teams Notification
      if: always()
      env:
        TEAMS_URL: ${{ secrets.TEAMS_URL }}
        WORKFLOW_STATUS: ${{ job.status }}
        RELEASE_VERSION: ${{ steps.get_version.outputs.version }}
      run: python teams-push.py