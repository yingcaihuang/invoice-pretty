name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘
    branches:
      - 'feature/web-application'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ç¡®å®šè¿è¡ŒçŽ¯å¢ƒ
  setup-env:
    runs-on: ubuntu-latest
    outputs:
      env_name: ${{ steps.set-env.outputs.env_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - id: set-env
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "env_name=pro" >> $GITHUB_OUTPUT
          else
            echo "env_name=dev" >> $GITHUB_OUTPUT
          fi

      - name: Send Approval Notification
        if: steps.set-env.outputs.env_name == 'pro'
        uses: ./.github/actions/teams-notification
        with:
          webhook_url: ${{ secrets.PRO_TEAMS_URL }}
          status: 'Waiting for Approval'
          version: ${{ github.ref_name }}
          message: ${{ github.event.head_commit.message }}

  # é€šçŸ¥ Approval å·²é€šè¿‡ (ä»… Pro çŽ¯å¢ƒ)
  notify-approval:
    needs: [setup-env]
    environment: ${{ needs.setup-env.outputs.env_name }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
          
      - name: Send Deployment Approved Notification
        if: needs.setup-env.outputs.env_name == 'pro'
        uses: ./.github/actions/teams-notification
        with:
          webhook_url: ${{ secrets.PRO_TEAMS_URL }}
          status: 'Deployment Approved'
          version: ${{ github.ref_name }}
          message: ${{ github.event.head_commit.message }}

  # Windowsæž„å»ºä½œä¸š
  build-windows:
    needs: [setup-env, notify-approval]
    environment: ${{ needs.setup-env.outputs.env_name }}
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build Windows EXE
      run: |
        python build_windows.py --exe-only
    
    - name: Create portable package
      run: |
        python build_windows.py --portable-only
    
    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: |
          dist/invoice_pretty.exe
          dist/invoice_pretty_portable.zip
        retention-days: 30

  # macOS Intel (x86_64) æž„å»ºä½œä¸š
  build-macos-intel:
    needs: [setup-env, notify-approval]
    environment: ${{ needs.setup-env.outputs.env_name }}
    runs-on: macos-15-intel  # Intel-based runner (updated from deprecated macos-13)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/Library/Caches/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install system dependencies
      run: |
        brew install create-dmg
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build macOS app and DMG (Intel) - Import Fixed Version
      run: |
        python build_import_fixed.py
    
    - name: Rename artifacts for Intel
      run: |
        cd dist
        if [ -f "invoice_pretty.dmg" ]; then
          mv "invoice_pretty.dmg" "invoice_pretty_intel.dmg"
        fi
        if [ -d "invoice_pretty.app" ]; then
          mv "invoice_pretty.app" "invoice_pretty_intel.app"
        fi
    
    - name: Upload macOS Intel artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-intel-build
        path: |
          dist/invoice_pretty_intel.dmg
          dist/invoice_pretty_intel.app
        retention-days: 30

  # macOS Apple Silicon (ARM64) æž„å»ºä½œä¸š
  build-macos-arm:
    needs: [setup-env, notify-approval]
    environment: ${{ needs.setup-env.outputs.env_name }}
    runs-on: macos-latest  # ARM-based runner (M1/M2)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/Library/Caches/pip
        key: ${{ runner.os }}-arm64-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-arm64-pip-
    
    - name: Install system dependencies
      run: |
        brew install create-dmg
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build macOS app and DMG (ARM64) - Import Fixed Version
      run: |
        python build_import_fixed.py
    
    - name: Rename artifacts for ARM64
      run: |
        cd dist
        if [ -f "invoice_pretty.dmg" ]; then
          mv "invoice_pretty.dmg" "invoice_pretty_arm64.dmg"
        fi
        if [ -d "invoice_pretty.app" ]; then
          mv "invoice_pretty.app" "invoice_pretty_arm64.app"
        fi
    
    - name: Upload macOS ARM64 artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-arm64-build
        path: |
          dist/invoice_pretty_arm64.dmg
          dist/invoice_pretty_arm64.app
        retention-days: 30

  # åˆ›å»ºGitHub Release
  create-release:
    needs: [setup-env, build-windows, build-macos-intel, build-macos-arm]
    environment: ${{ needs.setup-env.outputs.env_name }}
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
    
    - name: List downloaded files
      run: |
        echo "Downloaded artifacts:"
        find . -type f -name "*.exe" -o -name "*.dmg" -o -name "*.zip" -o -name "*.app" | sort
    
    - name: Create release notes
      id: release_notes
      run: |
        cat > release_notes.md << 'EOF'
        # PDFå‘ç¥¨æ‹¼ç‰ˆæ‰“å°ç³»ç»Ÿ ${{ steps.get_version.outputs.version }}
        
        ##  æ–°ç‰ˆæœ¬å‘å¸ƒ
        
        æ™ºèƒ½å¤„ç†12306ç”µå­å‘ç¥¨ï¼Œæ”¯æŒPDFå’ŒZIPæ–‡ä»¶ï¼Œä¸€é”®ç”Ÿæˆæ‹¼ç‰ˆæ‰“å°æ–‡ä»¶ã€‚
        
        ## [INFO] ç•Œé¢é¢„è§ˆ
        
        ### ä¸»ç•Œé¢
        ![ç³»ç»Ÿä¸»ç•Œé¢](https://raw.githubusercontent.com/yingcaihuang/invoice-pretty/main/img/assets/img1.png)
        
        ### å¤„ç†ç•Œé¢
        ![å¤„ç†ç•Œé¢](https://raw.githubusercontent.com/yingcaihuang/invoice-pretty/main/img/assets/img2.png)
        
        ## [INFO] ä¸‹è½½è¯´æ˜Ž
        
        ### Windowsç”¨æˆ·
        - **invoice_pretty.exe** - å•æ–‡ä»¶å¯æ‰§è¡Œç¨‹åºï¼ŒåŒå‡»å³å¯è¿è¡Œ
        - **invoice_pretty_portable.zip** - ç»¿è‰²ä¾¿æºç‰ˆï¼Œè§£åŽ‹å³ç”¨
        
        ### macOSç”¨æˆ·
        - **invoice_pretty_intel.dmg** - Intel Mac (x86_64) å®‰è£…åŒ…
        - **invoice_pretty_arm64.dmg** - Apple Silicon Mac (M1/M2) å®‰è£…åŒ…
        
        ## âœ¨ ä¸»è¦åŠŸèƒ½
        
        - ðŸ”„ æ”¯æŒPDFæ–‡ä»¶å’ŒZIPåŽ‹ç¼©åŒ…æ‰¹é‡å¤„ç†
        - ðŸ“„ 2åˆ—4è¡ŒA4çº¸å¼ æ‹¼ç‰ˆå¸ƒå±€ï¼ŒèŠ‚çœ50%çº¸å¼ 
        - ðŸŽ¨ çŽ°ä»£åŒ–å›¾å½¢ç”¨æˆ·ç•Œé¢
        - âš¡ å®žæ—¶å¤„ç†è¿›åº¦æ˜¾ç¤º
        - ðŸ“Š è¯¦ç»†çš„å¤„ç†æ—¥å¿—ä¿¡æ¯
        - [INFO] æ™ºèƒ½æ–‡ä»¶éªŒè¯å’Œé”™è¯¯å¤„ç†
        
        ## ðŸ–¥ï¸ ç³»ç»Ÿè¦æ±‚
        
        ### Windows
        - Windows 7/8/10/11 (64ä½æŽ¨è)
        - æ— éœ€é¢å¤–ä¾èµ–ï¼Œå¼€ç®±å³ç”¨
        
        ### macOS
        - macOS 10.14+ (Mojaveæˆ–æ›´é«˜ç‰ˆæœ¬)
        - Intel Macæˆ–Apple Silicon Mac
        
        ##  ä½¿ç”¨æ–¹æ³•
        
        1. ä¸‹è½½å¯¹åº”ç³»ç»Ÿçš„å®‰è£…åŒ…
        2. Windows: åŒå‡»EXEæ–‡ä»¶æˆ–è§£åŽ‹ä¾¿æºç‰ˆ
        3. macOS: æ‰“å¼€DMGæ–‡ä»¶ï¼Œæ‹–æ‹½åˆ°Applicationsæ–‡ä»¶å¤¹
        4. å¯åŠ¨ç¨‹åºï¼Œé€‰æ‹©PDFæ–‡ä»¶æˆ–ZIPåŽ‹ç¼©åŒ…
        5. é€‰æ‹©è¾“å‡ºç›®å½•ï¼Œç‚¹å‡»"å¼€å§‹æ‹¼ç‰ˆå¤„ç†"
        
        ## [INFO] æŠ€æœ¯ç‰¹æ€§
        
        - åŸºäºŽPyMuPDFçš„é«˜æ€§èƒ½PDFå¤„ç†
        - æ”¯æŒå¤šç§å›¾åƒæ ¼å¼å’ŒåŽ‹ç¼©ç®—æ³•
        - æ™ºèƒ½å¸ƒå±€ç®—æ³•ï¼Œä¿æŒå‘ç¥¨çºµæ¨ªæ¯”
        - 300DPIé«˜è´¨é‡è¾“å‡º
        - è·¨å¹³å°å…¼å®¹æ€§
        
        ## [INFO] åŠŸèƒ½å±•ç¤º
        
        | åŠŸèƒ½ç‰¹ç‚¹ | ç•Œé¢å±•ç¤º |
        |----------|----------|
        | **çŽ°ä»£åŒ–ç•Œé¢** | ç®€æ´ç¾Žè§‚çš„ç”¨æˆ·ç•Œé¢ï¼Œæ”¯æŒæ‹–æ‹½æ“ä½œ |
        | **æ‰¹é‡å¤„ç†** | ä¸€æ¬¡æ€§å¤„ç†å¤šä¸ªPDFæ–‡ä»¶å’ŒZIPåŽ‹ç¼©åŒ… |
        | **å®žæ—¶è¿›åº¦** | æ˜¾ç¤ºå¤„ç†è¿›åº¦å’Œè¯¦ç»†æ—¥å¿—ä¿¡æ¯ |
        | **æ™ºèƒ½å¸ƒå±€** | 2åˆ—4è¡Œæ‹¼ç‰ˆï¼ŒèŠ‚çœ50%çº¸å¼  |
        
        ### ä¸»è¦ç•Œé¢åŠŸèƒ½
        - ðŸŽ¯ **æ–‡ä»¶é€‰æ‹©**: æ”¯æŒæ‹–æ‹½æ·»åŠ PDFæ–‡ä»¶å’ŒZIPåŽ‹ç¼©åŒ…
        - ðŸ“ **æ‰¹é‡å¤„ç†**: ä¸€æ¬¡æ€§å¤„ç†å¤šä¸ªå‘ç¥¨æ–‡ä»¶  
        - âš¡ **å®žæ—¶è¿›åº¦**: æ˜¾ç¤ºå¤„ç†è¿›åº¦å’Œè¯¦ç»†æ—¥å¿—
        - ðŸŽ¨ **çŽ°ä»£è®¾è®¡**: ç®€æ´ç¾Žè§‚çš„ç”¨æˆ·ç•Œé¢
        
        ---
        
        å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·åœ¨GitHub Issuesä¸­åé¦ˆã€‚
        EOF
        
        echo "release_notes<<EOF" >> $GITHUB_OUTPUT
        cat release_notes.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        name: PDFå‘ç¥¨æ‹¼ç‰ˆæ‰“å°ç³»ç»Ÿ ${{ steps.get_version.outputs.version }}
        body: ${{ steps.release_notes.outputs.release_notes }}
        draft: false
        prerelease: false
        files: |
          ./windows-build/invoice_pretty.exe
          ./windows-build/invoice_pretty_portable.zip
          ./macos-intel-build/invoice_pretty_intel.dmg
          ./macos-arm64-build/invoice_pretty_arm64.dmg
        fail_on_unmatched_files: false

  # å‘é€é€šçŸ¥
  notify:
    needs: [setup-env, build-windows, build-macos-intel, build-macos-arm, create-release]
    runs-on: ubuntu-latest
    if: always()
    # ç§»é™¤ environment ç»‘å®šï¼Œé¿å…å†æ¬¡è§¦å‘å®¡æ ¸
    # environment: ${{ needs.setup-env.outputs.env_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine Environment and Secrets
        id: env-secrets
        run: |
          env_name="${{ needs.setup-env.outputs.env_name }}"
          echo "Environment: $env_name"
          
          if [ "$env_name" == "pro" ]; then
             echo "TEAMS_URL=${{ secrets.PRO_TEAMS_URL }}" >> $GITHUB_ENV
          else
             echo "TEAMS_URL=${{ secrets.DEV_TEAMS_URL }}" >> $GITHUB_ENV
          fi

      - name: Determine Workflow Status
        id: status
        run: |
          # æ£€æŸ¥æ‰€æœ‰ä¾èµ–ä½œä¸šçš„çŠ¶æ€
          # æ³¨æ„ï¼šcreate-release å¯èƒ½å› ä¸ºæ¡ä»¶ä¸æ»¡è¶³è€Œè¢«è·³è¿‡ï¼Œè¿™ç§æƒ…å†µä¸‹å®ƒçš„ result æ˜¯ skippedï¼Œä¸åº”è§†ä¸º failure
          if [ "${{ needs.build-windows.result }}" == "failure" ] || \
             [ "${{ needs.build-macos-intel.result }}" == "failure" ] || \
             [ "${{ needs.build-macos-arm.result }}" == "failure" ] || \
             ([ "${{ needs.create-release.result }}" == "failure" ] && [ "${{ needs.create-release.result }}" != "skipped" ]); then
            echo "status=failure" >> $GITHUB_OUTPUT
          elif [ "${{ needs.build-windows.result }}" == "cancelled" ] || \
               [ "${{ needs.build-macos-intel.result }}" == "cancelled" ] || \
               [ "${{ needs.build-macos-arm.result }}" == "cancelled" ]; then
            echo "status=cancelled" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
          fi

      - name: Get Workflow Start Time
        id: start_time
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          start_time=$(gh run view ${{ github.run_id }} --repo ${{ github.repository }} --json createdAt -q .createdAt)
          echo "start_time=$start_time" >> $GITHUB_OUTPUT

      - name: Send Teams Notification
        uses: ./.github/actions/teams-notification
        with:
          webhook_url: ${{ secrets.TEAMS_URL }}
          status: ${{ steps.status.outputs.status }}
          version: ${{ github.ref_name }}
          message: ${{ github.event.head_commit.message }}
          start_time: ${{ steps.start_time.outputs.start_time }}